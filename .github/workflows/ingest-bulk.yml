name: Ingest Bulk Sources

on:
  schedule:
    - cron: '0 6 1 * *'  # 1st of every month at 6 AM UTC
  workflow_dispatch:
    inputs:
      state:
        description: 'Single state to ingest (leave blank for all bulk states)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  ingest:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Checkout data branch
        uses: actions/checkout@v4
        with:
          ref: data
          path: data-output
        continue-on-error: true

      - name: Create data branch if needed
        run: |
          if [ ! -d "data-output/.git" ]; then
            mkdir -p data-output/data/states
            cd data-output
            git init
            git checkout -b data
          fi

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r pipeline/requirements.txt

      - name: Run bulk ingestion
        run: |
          if [ -n "${{ inputs.state }}" ]; then
            python -m pipeline.cli ingest \
              --state "${{ inputs.state }}" \
              --data-dir data/states \
              --content-dir data-output/data/states
          else
            python -m pipeline.cli ingest \
              --source-type law_resource_org \
              --data-dir data/states \
              --content-dir data-output/data/states

            python -m pipeline.cli ingest \
              --source-type internet_archive \
              --data-dir data/states \
              --content-dir data-output/data/states

            python -m pipeline.cli ingest \
              --source-type state_provided \
              --data-dir data/states \
              --content-dir data-output/data/states

            python -m pipeline.cli ingest \
              --source-type dc_council \
              --data-dir data/states \
              --content-dir data-output/data/states
          fi

      - name: Commit TOC/manifest changes to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git diff --cached --quiet || git commit -m "Update bulk source TOC/manifests [automated]"
          git push origin main
        continue-on-error: true

      - name: Commit content to data branch
        run: |
          cd data-output
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git diff --cached --quiet || git commit -m "Update bulk source content [automated]"
          git push origin data
        continue-on-error: true
